<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIQUIDWATCH</title>

  <!-- Autoriser iframe (Telegram) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src * 'self' 'unsafe-inline' data: blob:; frame-ancestors *;">

  <!-- Logo -->
  <style>
    body { margin: 0; font-family: sans-serif; color: #eee; background: #111; }
    header { display: flex; align-items: center; padding: 1rem; }
    header img { height: 32px; margin-right: .5rem; }
    h1 { margin: 0; font-size: 1.2rem; }
    .pair { background: #222; margin: .5rem; padding: .5rem; border-radius: 6px; }
    .pair img { height: 24px; vertical-align: middle; margin-right: .5rem; }
    .chart { width: 100%; height: 150px; }
  </style>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- TradingView (via widget) -->
  <script src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
  <header>
    <img src="https://ton-domaine.com/logo.png" alt="LIQUIDWATCH"/>
    <h1>LIQUIDWATCH</h1>
  </header>
  <div id="status">ðŸš€ Connecting...</div>
  <div id="pairs"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const status = document.getElementById('status');
    const pairsDiv = document.getElementById('pairs');
    let known = {};

    // Connexion WebSocket
    const ws = new WebSocket('wss://api.hyperliquid.xyz/ws');
    ws.onopen = () => status.innerText = 'âœ… Connected to Hyperliquid';
    ws.onerror = () => status.innerText = 'âŒ WS Error';
    ws.onclose = () => status.innerText = 'ðŸ”’ Disconnected';

    ws.onmessage = evt => {
      const msg = JSON.parse(evt.data);
      // Flux allMids : liste des paires
      if (msg.channel === 'allMids') {
        const mids = msg.data.mids;
        for (let pair of Object.keys(mids)) {
          if (!known[pair]) {
            known[pair] = mids[pair];
            addPair(pair);
          }
        }
      }
    };

    // Ajoute une paire dans le DOM
    function addPair(symbol) {
      const div = document.createElement('div');
      div.className = 'pair';
      div.id = `pair-${symbol}`;

      const img = document.createElement('img');
      img.src = `https://cryptoicons.org/api/icon/${symbol.split('-')[0].toLowerCase()}/32`;
      img.onerror = () => img.src = 'https://via.placeholder.com/32';

      const title = document.createElement('span');
      title.innerText = symbol;

      // Conteneur du graphique TradingView
      const chart = document.createElement('div');
      chart.className = 'chart';
      chart.id = `chart-${symbol}`;

      div.append(img, title, chart);
      pairsDiv.prepend(div);

      // Ajout du widget TradingView
      new TradingView.widget({
        container_id: chart.id,
        width: '100%',
        height: 150,
        symbol: `BINANCE:${symbol.replace('-', '')}USD`,
        interval: '1',
        theme: 'dark',
        style: '1',
        toolbar_bg: '#222',
        hide_side_toolbar: true,
        allow_symbol_change: false,
      });
    }
  </script>
</body>
</html>
